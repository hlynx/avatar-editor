/*!
 * AvatarEditor v0.2.0
 * https://github.com/hlynx/avatar-editor.git
 * Copyright 2014 hlynx <hlynx@users.noreply.github.com>
 */
angular.module("avatarEditor",["ngImgCrop"]).directive("avatarEditor",["$log",function(a){return{restrict:"EA",replace:!0,scope:{src:"@",modeUpload:"@",modeEdit:"@",modeCamera:"@"},template:'<div class="avatar-editor">            <img-crop class="ng-img-crop" ng-show="stage == 2 && modeEdit" data-image="resultSrc" data-result-image="croppedSrc" data-area-type="square" data-area-min-size="100"></img-crop>            <label ng-show="stage == 1 && modeUpload" class="img-outer">                <img ng-src="{{src}}">                <input type="file">            </label>            <div ng-show="stage == 1 && !modeUpload" class="img-outer">                <img ng-src="{{src}}">            </div>            <div ng-show="stage == 3 && modeCamera" class="img-outer">                <video autoplay></video>                <canvas></canvas>            </div>            <div class="avatar-editor-buttons">                <a class="avatar-editor-button-camera glyphicon glyphicon-camera" ng-click="camera()" ng-show="stage == 1 && modeCamera"></a>                                <a class="avatar-editor-button-done glyphicon glyphicon-ok" ng-click="cameraDone()" ng-show="stage == 3 && modeEdit"></a>                <a class="avatar-editor-button-done glyphicon glyphicon-ok" ng-click="done()" ng-show="stage == 2 && modeEdit"></a>                <a class="avatar-editor-button-close glyphicon glyphicon-remove" ng-click="setStage1()" ng-show="(stage == 2 || stage == 3) && modeEdit"></a>            </div>        </div>',link:function(b,c){function d(b){var c=null,d=!1,e=b.children();for(var f in e)if("LABEL"==e[f].tagName){c=e[f];break}if(!c)return a.warn("avatarEditor: label not found"),!1;e=c.children;for(var f in e)if("INPUT"==e[f].tagName){d=e[f];break}return d}function e(a){return a.find("VIDEO")[0]}function f(a){var c=a.currentTarget.files[0],d=new FileReader;d.onload=function(a){b.$apply(function(c){c.resultSrc=a.target.result,c.modeEdit?c.setStage2():(b.src=b.resultSrc,c.setStage1())})},d.readAsDataURL(c)}function g(){j&&(j.stop(),j=null)}b.resultSrc=b.src||"",b.croppedSrc="",b.setStage1=function(){b.stage=1},b.setStage2=function(){b.stage=2},b.setStage3=function(){b.stage=3};var h=d(c),i=e(c);if(!h)return void a.warn('avatarEditor: input[type="file"] not found');b.setStage1(),b.modeUpload&&h.addEventListener("change",f),b.$on("$destroy",function(){h.removeEventListener("change",f)});var j=null;b.done=function(){b.src=b.croppedSrc,b.setStage1()},b.camera=function(){navigator._getUserMedia=window.navigator.getUserMedia||window.navigator.webkitGetUserMedia||window.navigator.mozGetUserMedia||window.navigator.msGetUserMedia,navigator._getUserMedia({video:!0},function(a){j=a,i.src=window.URL.createObjectURL(a)},function(){console.log("error")}),b.setStage3()},b.cameraDone=function(){var a=document.createElement("canvas");a.width=c.prop("offsetWidth"),a.height=c.prop("offsetHeight"),context=a.getContext("2d"),context.drawImage(i,0,0,a.width,a.height);var d=a.toDataURL();b.resultSrc=d,b.modeEdit?b.setStage2():(b.src=d,b.setStage1()),g()}}}}]);